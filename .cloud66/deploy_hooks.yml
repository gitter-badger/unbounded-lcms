production: &production
  after_bundle:
    - command: cd $STACK_PATH && BUNDLE_GEMFILE=$STACK_PATH/Gemfile bundle exec rake cloud66:after_bundle
      target: rails
      execute: true
      run_on: all_servers
      apply_during: all
  after_symlink:
    - command: cd $STACK_PATH && BUNDLE_GEMFILE=$STACK_PATH/Gemfile bundle exec rake cloud66:after_symlink
      target: rails
      execute: true
      run_on: single_server
      apply_during: all
    - source: /.cloud66/setup_uploads_folder.sh
      destination: /tmp/setup_uploads_folder.sh
      target: rails
      execute: true
      sudo: true
      apply_during: all
      run_on: all_servers
  first_thing:
    - source: /.cloud66/install_wkhtmltopdf.sh
      destination: /tmp/install_wkhtmltopdf.sh
      target: rails
      execute: true
      sudo: true
      apply_during: build_only
      run_on: all_servers
    - source: /.cloud66/install_varnish.sh
      destination: /tmp/install_varnish.sh
      target: rails
      execute: true
      sudo: true
      apply_during: build_only
      run_on: all_servers
    - source: /.cloud66/install_fonts.sh
      destination: /tmp/install_fonts.sh
      target: rails
      execute: true
      sudo: true
      apply_during: all
      run_on: all_servers
  after_rails:
    - command: cd $STACK_PATH && chgrp -R app_writers tmp && chown -R nginx:app_writers tmp && chmod 775 tmp && chmod g+s tmp && chmod -R g+rw tmp
      target: rails
      execute: true
      run_on: all_servers
      apply_during: all
      sudo: true
    - command: cd $STACK_PATH && chgrp -R app_writers public && chown -R nginx:app_writers public && chmod 775 public && chmod g+s public && chmod -R g+rw public
      target: rails
      execute: true
      run_on: all_servers
      apply_during: all
      sudo: true
    - command: cd $STACK_PATH && chmod 0777 -R $RAILS_STACK_PATH/tmp/uploads
      target: rails
      execute: true
      run_on: all_servers
      apply_during: all
      sudo: true
staging:
  <<: *production
  after_symlink:
    - command: sudo cp -R $STACK_PATH/.cloud66/public/staging/* $STACK_PATH/public
      target: rails
      execute: true
      run_on: all_servers
      apply_during: all
development:
  <<: *production
  after_symlink:
    - command: sudo cp -R $STACK_PATH/.cloud66/public/development/* $STACK_PATH/public
      target: rails
      execute: true
      run_on: all_servers
      apply_during: all
